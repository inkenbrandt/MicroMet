

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>micromet.graphs &mdash; micromet 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            micromet
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">micromet</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">micromet.graphs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for micromet.graphs</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>

<div class="viewcode-block" id="energy_sankey">
<a class="viewcode-back" href="../../source/micromet.html#micromet.graphs.energy_sankey">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">energy_sankey</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_text</span><span class="o">=</span><span class="s2">&quot;2024-06-19 12:00&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Sankey diagram representing the energy balance for a specific date and time.</span>

<span class="sd">    This function generates a Sankey diagram to visualize the flow of energy in a system,</span>
<span class="sd">    typically used in meteorological or environmental studies. It calculates various</span>
<span class="sd">    energy balance components and creates a diagram showing their relationships.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A DataFrame containing time series data with columns for different energy</span>
<span class="sd">        components (SW_IN, LW_IN, SW_OUT, LW_OUT, NETRAD, G, LE, H).</span>
<span class="sd">    date_text : str, optional</span>
<span class="sd">        A string representing the date and time for which to create the diagram.</span>
<span class="sd">        Default is &quot;2024-06-19 12:00&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    plotly.graph_objs._figure.Figure</span>
<span class="sd">        A Plotly Figure object containing the Sankey diagram.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - The function assumes that the DataFrame index is a DatetimeIndex.</span>
<span class="sd">    - Energy balance components are extracted from the DataFrame for the specified date.</span>
<span class="sd">    - The energy balance ratio (EBR) is calculated as (H + LE) / (NETRAD - G).</span>
<span class="sd">    - The residual term is calculated as NETRAD - (G + H + LE).</span>
<span class="sd">    - The Sankey diagram visualizes the flow of energy between different components.</span>

<span class="sd">    Energy Balance Components:</span>
<span class="sd">    --------------------------</span>
<span class="sd">    - SW_IN: Incoming Shortwave Radiation</span>
<span class="sd">    - LW_IN: Incoming Longwave Radiation</span>
<span class="sd">    - SW_OUT: Outgoing Shortwave Radiation</span>
<span class="sd">    - LW_OUT: Outgoing Longwave Radiation</span>
<span class="sd">    - NETRAD: Net Radiation</span>
<span class="sd">    - G: Ground Heat Flux</span>
<span class="sd">    - LE: Latent Heat</span>
<span class="sd">    - H: Sensible Heat</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import plotly.graph_objs</span>
<span class="sd">    &gt;&gt;&gt; # Assume &#39;df&#39; is a properly formatted DataFrame with energy balance data</span>
<span class="sd">    &gt;&gt;&gt; fig = energy_sankey(df, &quot;2024-06-19 12:00&quot;)</span>
<span class="sd">    &gt;&gt;&gt; fig.show()</span>

<span class="sd">    Dependencies:</span>
<span class="sd">    -------------</span>
<span class="sd">    - pandas</span>
<span class="sd">    - plotly.graph_objs</span>

<span class="sd">    See Also:</span>
<span class="sd">    ---------</span>
<span class="sd">    plotly.graph_objs.Sankey : For more information on creating Sankey diagrams with Plotly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">select_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_text</span><span class="p">)</span>
    <span class="n">swi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;SW_IN&quot;</span><span class="p">]</span>
    <span class="n">lwi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;LW_IN&quot;</span><span class="p">]</span>
    <span class="n">swo</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;SW_OUT&quot;</span><span class="p">]</span>
    <span class="n">lwo</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;LW_OUT&quot;</span><span class="p">]</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;NETRAD&quot;</span><span class="p">]</span>
    <span class="n">shf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]</span>
    <span class="n">le</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;LE&quot;</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_date</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">]</span>

    <span class="c1"># Define the energy balance terms and their indices</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Incoming Shortwave Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Incoming Longwave Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total Incoming Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Outgoing Shortwave Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Outgoing Longwave Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Net Radiation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ground Heat Flux&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sensible Heat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Latent Heat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Residual&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">-</span> <span class="p">(</span><span class="n">shf</span> <span class="o">+</span> <span class="n">h</span> <span class="o">+</span> <span class="n">le</span><span class="p">)</span>

    <span class="n">ebr</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">le</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="n">shf</span><span class="p">)</span>

    <span class="c1"># Define the source and target nodes and the corresponding values for the energy flow</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># Indices of the source nodes</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># Indices of the target nodes</span>

    <span class="c1"># Define the source and target nodes and the corresponding values for the energy flow</span>
    <span class="c1"># source = [0, 1, 2, 2, 2, 5, 5, 5, 5]  # Indices of the source nodes</span>
    <span class="c1"># target = [2, 2, 5, 3, 4, 6, 7, 8, 9]  # Indices of the target nodes</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">lwi</span><span class="p">,</span> <span class="n">swi</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">swo</span><span class="p">,</span> <span class="n">lwo</span><span class="p">,</span> <span class="n">shf</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">rem</span><span class="p">]</span>  <span class="c1"># Values of the energy flow</span>

    <span class="c1"># Create the Sankey diagram</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Sankey</span><span class="p">(</span>
                <span class="n">node</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                    <span class="n">thickness</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">link</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Update layout and title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Energy Balance </span><span class="si">{</span><span class="n">ebr</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">select_date</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>

    <span class="c1"># Show the figure</span>
    <span class="c1"># fig.show()</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="scatterplot_instrument_comparison">
<a class="viewcode-back" href="../../source/micromet.html#micromet.graphs.scatterplot_instrument_comparison">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scatterplot_instrument_comparison</span><span class="p">(</span><span class="n">edmet</span><span class="p">,</span> <span class="n">compare_dict</span><span class="p">,</span> <span class="n">station</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a scatterplot comparing two instrument measurements with regression analysis.</span>

<span class="sd">    This function compares two instruments specified in `compare_dict` by plotting</span>
<span class="sd">    their 1-hour mean values, interpolating missing data, and performing linear regression.</span>
<span class="sd">    It includes a 1:1 reference line and displays key regression statistics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edmet : pandas.DataFrame</span>
<span class="sd">        DataFrame containing environmental measurements, indexed by datetime.</span>
<span class="sd">    compare_dict : dict</span>
<span class="sd">        Dictionary where keys are instrument column names and values are tuples of</span>
<span class="sd">        metadata in the format (variable, instrument label, units).</span>
<span class="sd">    station : str</span>
<span class="sd">        Identifier for the station to annotate the plot title.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slope : float</span>
<span class="sd">        Slope of the linear regression line.</span>
<span class="sd">    intercept : float</span>
<span class="sd">        Intercept of the linear regression line.</span>
<span class="sd">    r_squared : float</span>
<span class="sd">        Coefficient of determination ($R^2$) from the regression.</span>
<span class="sd">    p_value : float</span>
<span class="sd">        Two-sided p-value for a hypothesis test whose null hypothesis is that the slope is zero.</span>
<span class="sd">    std_err : float</span>
<span class="sd">        Standard error of the estimated slope.</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The matplotlib figure object.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The matplotlib axes object containing the plot.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Missing values (-9999) are replaced with NaN before processing.</span>
<span class="sd">    - The data is resampled to hourly frequency and linearly interpolated.</span>
<span class="sd">    - The regression line and 1:1 line are plotted for visual comparison.</span>
<span class="sd">    - X and Y axes are labeled using metadata from `compare_dict`.</span>
<span class="sd">    - The function both displays the plot and prints regression statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compare two instruments</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compare_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">edmet</span><span class="p">[</span><span class="n">instruments</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">xinfo</span> <span class="o">=</span> <span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">yinfo</span> <span class="o">=</span> <span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># one to one line</span>
    <span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># Perform linear regression</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="c1"># Predict y values</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">intercept</span>
    <span class="c1"># R-squared</span>
    <span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="c1"># Plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data points&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> Comparison: </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span> <span class="n">xline</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;1:1 line&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y_pred</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fit: y = </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x + </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">$R^2$ = </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">xinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">xinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">yinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">yinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">yinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Print results</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slope: </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intercept: </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_squared</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="bland_alt_plot">
<a class="viewcode-back" href="../../source/micromet.html#micromet.graphs.bland_alt_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bland_alt_plot</span><span class="p">(</span><span class="n">edmet</span><span class="p">,</span> <span class="n">compare_dict</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Bland–Altman plot to assess agreement between two instruments.</span>

<span class="sd">    This function compares two instruments specified in `compare_dict` by plotting the</span>
<span class="sd">    mean of their measurements against their difference. It reports the root mean square error</span>
<span class="sd">    (RMSE), bias, and spread, and visualizes the limits of agreement.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    edmet : pandas.DataFrame</span>
<span class="sd">        DataFrame containing environmental measurements, indexed by datetime.</span>
<span class="sd">    compare_dict : dict</span>
<span class="sd">        Dictionary where keys are instrument column names and values are tuples of</span>
<span class="sd">        metadata in the format (variable, instrument label, units).</span>
<span class="sd">    station : str</span>
<span class="sd">        Name or identifier for the measurement station, used in plot titles.</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        Transparency of the plot elements. Default is 0.5.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f : matplotlib.figure.Figure</span>
<span class="sd">        The matplotlib figure object containing the plot.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The matplotlib axes object for the Bland–Altman plot.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Missing values (-9999) are replaced with NaN before processing.</span>
<span class="sd">    - Data is resampled to hourly frequency and linearly interpolated.</span>
<span class="sd">    - Bias is calculated as the mean difference between instruments.</span>
<span class="sd">    - Spread is the standard deviation of the difference.</span>
<span class="sd">    - Limits of agreement are shown at ±1.96 × standard deviation.</span>
<span class="sd">    - The `statsmodels.graphics.mean_diff_plot` utility is used for plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compare two instruments</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compare_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">edmet</span><span class="p">[</span><span class="n">instruments</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">mean_vals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">instruments</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">diff_vals</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bias = </span><span class="si">{</span><span class="n">bias</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Spread = </span><span class="si">{</span><span class="n">spread</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">diff_vals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">graphics</span><span class="o">.</span><span class="n">mean_diff_plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">mean_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">top</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">mean_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">bottom</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Mean </span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Difference (</span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">compare_dict</span><span class="p">[</span><span class="n">instruments</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">ax</span></div>



<span class="c1"># Example of filtering by date range</span>
<div class="viewcode-block" id="plot_timeseries_daterange">
<a class="viewcode-back" href="../../source/micromet.html#micromet.graphs.plot_timeseries_daterange">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_timeseries_daterange</span><span class="p">(</span>
    <span class="n">input_df</span><span class="p">,</span> <span class="n">selected_station</span><span class="p">,</span> <span class="n">selected_field</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a time series for a specific station and variable within a date range.</span>

<span class="sd">    This function extracts and visualizes a single time series from a multi-station</span>
<span class="sd">    DataFrame, limited to a specified date range and filtered by station ID and</span>
<span class="sd">    data field. It handles missing values and generates a time series plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing a multi-index (station, timestamp) with time series data.</span>
<span class="sd">    selected_station : str</span>
<span class="sd">        Station identifier to select from the DataFrame.</span>
<span class="sd">    selected_field : str</span>
<span class="sd">        Column name of the variable to plot (e.g., temperature, humidity).</span>
<span class="sd">    start_date : str or pandas.Timestamp</span>
<span class="sd">        Start date of the time range to include in the plot.</span>
<span class="sd">    end_date : str or pandas.Timestamp</span>
<span class="sd">        End date of the time range to include in the plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays a matplotlib plot but does not return any value.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Assumes `input_df` is indexed by station and datetime (MultiIndex).</span>
<span class="sd">    - Missing values equal to -9999 are replaced with NaN prior to plotting.</span>
<span class="sd">    - The function sets global variables `fig` and `ax`, which may overwrite</span>
<span class="sd">      other plots in an interactive session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
    <span class="c1"># ax.clear()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Filter data by date range</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_station</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">selected_field</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Plot each selected category</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">selected_station</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">selected_station</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">selected_field</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="save_plot">
<a class="viewcode-back" href="../../source/micromet.html#micromet.graphs.save_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_plot</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves plot for an interactive notebook button function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This line saves the plot as a .png file. Change it to .pdf to save as pdf.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plot.png&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Paul Inkenbrandt &amp; Kathryn Ladig.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>